# DD-5KA · Master Prompt & Workflow (единый источник правды)

Этот документ — центральная точка знания проекта.  
Любой ИИ-ассистент обязан работать строго по этому файлу.  
Все изменения кода/конфигурации должны отражаться здесь.

Правило №1: **один ответ ИИ = одна правка/одна команда проверки.**
Правило №2: без изменения архитектуры без RFC.
Правило №3: все пути и окружение фиксируются в этом документе.

## 1) Коротко о проекте

**DD-5KA** — система детекции дронов на базе Raspberry Pi 5.  
Используются камера Sony IMX500 и Python-сервис для анализа видеопотока (YOLO).  
Отдельный Flask-сервис предоставляет веб-панель (MJPEG-видеопоток, снимки и health-чеки).

Текущая цель этапа разработки:  
стабильный запуск панели и детектора, логирование событий и корректная работа камеры.

## 2) Архитектура и окружение (общая фиксация)

Аппаратная часть:
- Raspberry Pi 5
- Камера Sony IMX500 (через `libcamera` / `rpicam-*`)
- (опционально) AI-ускоритель Hailo-8 PCIe

Софт:
- ОС: Debian 12 (aarch64)
- Детектор: Python + Ultralytics YOLO
- Панель: Flask (веб-интерфейс)
- Менеджер процессов: systemd

Развёртывание:
- Панель и Детектор — это **два отдельных Python-сервиса**
- Каждый работает как systemd unit
- Логи пишутся в отдельную директорию
- Управление сервисами производится через `systemctl`

## 3) Структура каталогов и важные пути (на Raspberry Pi)

Корень проекта:
`/home/nemez/project_root/`

Основные директории:
/home/nemez/project_root/
src/
panel/ # Flask-панель (веб-UI)
detector/ # YOLO-инференс и обработка кадров
models/ # веса моделей (YOLO HEF/ONNX/PT)
configs/ # .env и конфигурационные файлы
logs/ # логи сервисов и detections.jsonl
docs/ # документация (в т.ч. PROMPT_MASTER)

markdown


Виртуальное окружение детектора:
`/home/nemez/drone-env/`

Сервисы (systemd):
- `dd5ka-panel.service`  → Flask UI
- `dd5ka-detector.service` → YOLO-детектор

Расположение логов по умолчанию:
`/home/nemez/project_root/logs/`

## 4) Переменные окружения и конфиги

Файл с переменными: `configs/.env`  
Пример: `configs/.env.example`

Ключевые переменные:
- `DD5KA_BACKEND=cpu|hailo` — бэкенд инференса
- `DD5KA_SOURCE=mjpeg|snapshot` — источник кадров
- `YOLO_WEIGHTS=/home/nemez/yolov8n.pt` — путь к весам модели
- `PANEL_HOST=0.0.0.0` — хост Flask-панели
- `PANEL_PORT=8098` — порт Flask-панели
- `LOG_DIR=/home/nemez/project_root/logs` — директория логов
- `DETECTIONS_JSONL=/home/nemez/project_root/logs/detections.jsonl` — файл событий

Шаблон `.env.example`:
DD5KA_BACKEND=cpu
DD5KA_SOURCE=mjpeg
YOLO_WEIGHTS=/home/nemez/yolov8n.pt
PANEL_HOST=0.0.0.0
PANEL_PORT=8098
LOG_DIR=/home/nemez/project_root/logs
DETECTIONS_JSONL=/home/nemez/project_root/logs/detections.jsonl

## 5) Команды диагностики на Raspberry Pi

### Проверка камеры
rpicam-still -o /dev/null


### Статус панели (Flask)
systemctl --no-pager --full status dd5ka-panel.service || true
journalctl -xeu dd5ka-panel.service --no-pager -n 200 || true
tail -n 120 /home/nemez/project_root/logs/panel.log || true


### Статус детектора (YOLO)
systemctl --no-pager --full status dd5ka-detector.service || true
journalctl -xeu dd5ka-detector.service --no-pager -n 200 || true
tail -n 120 /home/nemez/project_root/logs/detector.log || true


### Проверка Hailo (если используется)
systemctl --no-pager --full status hailort.service || true


### Перезапуск сервисов
sudo systemctl restart dd5ka-panel.service dd5ka-detector.service

## 6) Протокол работы ИИ-ассистента

1. Один ответ = **одна правка / одно действие / одна команда проверки**.
2. Любая правка оформляется как:
   - полный файл целиком, **или**
   - unified-diff с точным путём к файлу.
3. После правки ассистент обязан дать **одну** команду для проверки результата.
4. Никаких массовых изменений «всё сразу».  
   Итерации только пошаговые.
5. Любые изменения архитектуры (структуры каталогов, логики работы сервисов, модели ИИ, пайплайна обработки) — **только по RFC**, а не в обычном ответе.
6. Все изменения, которые касаются окружения или конфигурации, **обязательно** фиксируются в этом файле.
7. Если ассистент не понимает текущее состояние — он сначала выполняет диагностику (через команды из раздела 5), а уже потом предлагает правку.

## 7) Протокол входа нового ИИ-ассистента

Перед началом работы ассистент обязан:

1. Прочитать `PROMPT_MASTER.md` полностью.
2. Синхронизироваться с текущим кодом:
   - `src/panel/` — Flask-панель
   - `src/detector/` — YOLO-детектор
3. Если какие-либо файлы не были показаны в чате — запросить вывод (`cat`, `ls`, `diff`).
4. Сформировать краткий обзор: что уже реализовано и в каком состоянии.
5. Только после синхронизации с кодовой базой — предлагать правки.
6. Запрещено создавать новую реализацию “с нуля”, если код уже существует.
7. Все изменения — пошагово, по протоколу «один ответ = одна правка + одна команда проверки».

## 8) Протокол передачи чата новому ассистенту

Когда создаётся новый чат или подключается новый агент, пользователь обязан:

1. Указать, что проект ведётся по `PROMPT_MASTER.md`.
2. Сообщить путь к этому файлу (локально или в репозитории).
3. Сформулировать задачу в стиле:  
   «Прочитай `PROMPT_MASTER.md`, синхронизируйся с текущим кодом и продолжи работу пошагово».

Ассистент обязан:

1. Сначала подтвердить чтение `PROMPT_MASTER.md`.
2. Затем запросить текущее состояние кода (если нужно — вывод `ls`/`cat` отдельных файлов).
3. Сделать краткий обзор реального состояния (что уже есть, что не реализовано).
4. Только после синхронизации предложить первую минимальную правку.
5. Соблюдать правило: **никакого переписывания с нуля** при существующем коде.


## 9) Break-glass / восстановление ассистента

Если ассистент начал:
- терять контекст,
- игнорировать протокол,
- предлагать переписывание с нуля,
- или выдавать нерелевантные ответы,

то пользователь выполняет «перезагрузку ассистента» без потери проекта:

**Процедура восстановления:**

1. Сообщить ассистенту фразу:  
   «Восстанови контекст: прочитай PROMPT_MASTER.md и выполни входной протокол».
2. Ассистент обязан перечитать документ и синхронизироваться с кодовой базой.
3. Ассистент обязан выдать краткий обзор текущего состояния (snapshot).
4. После этого работа продолжается с того же места.

**Важно:**  
Перезагрузка ассистента не даёт права переписывать проект или структуру заново.  
Если предлагаются масштабные изменения — только через RFC.

## 10) Версионирование и синхронизация документа

Этот файл является частью кода и версионируется через git.

Правила обновления:
1. Любое изменение конфигурации, структуры, сервисов, путей или переменных окружения обязано быть отражено здесь.
2. Перед коммитом проверяется, что PROMPT_MASTER.md актуализирован.
3. Каждое значимое изменение фиксируется отдельным коммитом с сообщением вида:
   `docs: update PROMPT_MASTER (<что изменено>)`.
4. Новый ассистент не считается «вошедшим в проект», пока не подтвердит чтение актуальной версии файла из репозитория.

## 11) Ссылка на репозиторий (единый источник правды)

Публичный URL (read-only для ассистентов):
https://github.com/nemezkarl-source/DD5KA

Правило: любой новый ассистент начинает работу с чтения `docs/PROMPT_MASTER.md` в этом репозитории, затем — синхронизация с текущим кодом по разделу «Протокол входа», и только после этого — минимальные правки по протоколу «один ответ = одна правка + одна команда проверки».

## 12) RAW-доступ к репозиторию (для ассистентов)

PROMPT_MASTER (RAW):
https://raw.githubusercontent.com/nemezkarl-source/DD5KA/main/docs/PROMPT_MASTER.md

Шаблон для любого файла:
https://raw.githubusercontent.com/nemezkarl-source/DD5KA/main/<путь/к/файлу>

Готовые ссылки на ключевые файлы проекта:

- Flask-панель (app.py)
  https://raw.githubusercontent.com/nemezkarl-source/DD5KA/main/src/panel/app.py

- systemd unit панели
  https://raw.githubusercontent.com/nemezkarl-source/DD5KA/main/configs/dd5ka-panel.service

Детектор:
- пока отсутствует в репозитории (разработка на RPi)
- ассистент НЕ должен генерировать новый код без синхронизации с фактической версией
- если потребуется, ассистент может запросить RAW-ссылку после того, как файл окажется в репозитории

Правила RAW-доступа:
1. Ассистент обязан читать файлы через RAW-ссылки, а не через HTML UI GitHub.
2. Пользователь не обязан присылать код вручную.
3. Запросы “пришли файл src/panel/app.py” считаются ошибочным входом.
4. Если файл отсутствует в репозитории — ассистент обязан запросить загрузку, а не пытаться писать с нуля.

## 13) Разделение ролей ассистентов (Cursor = исполнитель, чат = постановщик)

Архитектурное правило CH4:
Код генерирует и изменяет **Cursor в IDE**, чат-ассистент только **инициирует patch-задачи**.

Роли:

- Чат-ассистент (ChatGPT / LLM-чат):
  · Анализирует состояние проекта
  · Формирует задачу в виде промпта для Cursor
  · НЕ пишет код напрямую
  · Контролирует результат и проверку
  · При необходимости формирует уточняющий запрос к Cursor

- Cursor (IDE-агент):
  · Единственный исполнитель кода
  · Генерирует патчи (diff или полный файл)
  · Выдаёт одну команду проверки
  · Не решает ЧТО делать — только исполняет сформулированную задачу

Поведение по умолчанию:
1. Если чат по ошибке начинает писать код — он обязан **немедленно преобразовать попытку в корректный Cursor-промпт**.
2. Любая правка = patch в Cursor → затем применение на RPi → проверка.
3. Запрещено генерировать код в чате напрямую (минуя Cursor).
4. Пользователь не обязан вручную пересылать код — Cursor и RAW-доступ обеспечивают синхронизацию.

Цель:
Гарантировать воспроизводимость и отсутствие рассинхронизации между чатами, IDE и реальным кодом устройства.

## 14) Контур обновления кода (Mac → GitHub → RPi)

Проект DD-5KA использует строгий односторонний CI/CD-контур поставки кода:

1. Разработка выполняется **только на Mac**. Raspberry Pi не является средой разработки.
2. Код генерируется и правится **только через Cursor** (IDE), а не в чате.
3. После генерации патчей Cursor → изменения коммитятся и пушатся в GitHub.
4. GitHub является единым источником правды. Raspberry Pi = runtime-копия репозитория.
5. Обновление на устройстве выполняется ТОЛЬКО через:
git pull
systemctl restart <service>
6. Запрещено вносить правки вручную на RPi (nano, vim, python -c и т.п.).
7. Любой запрос «правь файл на Raspberry Pi» = нарушение протокола.

---

## 15) Интерфейс применения правок (обязательная последовательность)

Каждая правка кода завершается **выдачей полного набора команд для применения**:

1. Обновление репозитория:
git add ...
git commit ...
git push

2. Применение на Raspberry Pi (ассистент обязан выдать эти команды полностью):
ssh nemez@pi-drone.local
cd /home/nemez/project_root
git pull
sudo systemctl restart <service>

3. Проверка результата (пример):
curl http://pi-drone.local:8098/healthz
или `tail -n 50 logs/...`

Правка считается завершённой **ТОЛЬКО** после:
- push в GitHub
- pull на RPi
- restart службы
- подтверждённой проверки.

Чат-ассистент обязан всегда выдавать эти команды автоматически.
