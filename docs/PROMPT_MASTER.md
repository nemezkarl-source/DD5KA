# DD-5KA · Master Prompt & Workflow (единый источник правды)

Этот документ — центральная точка знания проекта.  
Любой ИИ-ассистент обязан работать строго по этому файлу.  
Все изменения кода/конфигурации должны отражаться здесь.

Правило №1: **один ответ ИИ = одна правка/одна команда проверки.**
Правило №2: без изменения архитектуры без RFC.
Правило №3: все пути и окружение фиксируются в этом документе.

## 1) Коротко о проекте

**DD-5KA** — система детекции дронов на базе Raspberry Pi 5.  
Используются камера Sony IMX500 и Python-сервис для анализа видеопотока (YOLO).  
Отдельный Flask-сервис предоставляет веб-панель (MJPEG-видеопоток, снимки и health-чеки).

Текущая цель этапа разработки:  
стабильный запуск панели и детектора, логирование событий и корректная работа камеры.

## 2) Архитектура и окружение (общая фиксация)

Аппаратная часть:
- Raspberry Pi 5
- Камера Sony IMX500 (через `libcamera` / `rpicam-*`)
- (опционально) AI-ускоритель Hailo-8 PCIe

Софт:
- ОС: Debian 12 (aarch64)
- Детектор: Python + Ultralytics YOLO
- Панель: Flask (веб-интерфейс)
- Менеджер процессов: systemd

Развёртывание:
- Панель и Детектор — это **два отдельных Python-сервиса**
- Каждый работает как systemd unit
- Логи пишутся в отдельную директорию
- Управление сервисами производится через `systemctl`

## 3) Структура каталогов и важные пути (на Raspberry Pi)

Корень проекта:
`/home/nemez/project_root/`

Основные директории:
/home/nemez/project_root/
src/
panel/ # Flask-панель (веб-UI)
detector/ # YOLO-инференс и обработка кадров
models/ # веса моделей (YOLO HEF/ONNX/PT)
configs/ # .env и конфигурационные файлы
logs/ # логи сервисов и detections.jsonl
docs/ # документация (в т.ч. PROMPT_MASTER)

markdown


Виртуальное окружение детектора:
`/home/nemez/drone-env/`

Сервисы (systemd):
- `dd5ka-panel.service`  → Flask UI
- `dd5ka-detector.service` → YOLO-детектор

Расположение логов по умолчанию:
`/home/nemez/project_root/logs/`

## 4) Переменные окружения и конфиги

Файл с переменными: `configs/.env`  
Пример: `configs/.env.example`

Ключевые переменные:
- `DD5KA_BACKEND=cpu|hailo` — бэкенд инференса
- `DD5KA_SOURCE=mjpeg|snapshot` — источник кадров
- `YOLO_WEIGHTS=/home/nemez/yolov8n.pt` — путь к весам модели
- `PANEL_HOST=0.0.0.0` — хост Flask-панели
- `PANEL_PORT=8098` — порт Flask-панели
- `LOG_DIR=/home/nemez/project_root/logs` — директория логов
- `DETECTIONS_JSONL=/home/nemez/project_root/logs/detections.jsonl` — файл событий

Шаблон `.env.example`:
DD5KA_BACKEND=cpu
DD5KA_SOURCE=mjpeg
YOLO_WEIGHTS=/home/nemez/yolov8n.pt
PANEL_HOST=0.0.0.0
PANEL_PORT=8098
LOG_DIR=/home/nemez/project_root/logs
DETECTIONS_JSONL=/home/nemez/project_root/logs/detections.jsonl

## 5) Команды диагностики на Raspberry Pi

### Проверка камеры
rpicam-still -o /dev/null


### Статус панели (Flask)
systemctl --no-pager --full status dd5ka-panel.service || true
journalctl -xeu dd5ka-panel.service --no-pager -n 200 || true
tail -n 120 /home/nemez/project_root/logs/panel.log || true


### Статус детектора (YOLO)
systemctl --no-pager --full status dd5ka-detector.service || true
journalctl -xeu dd5ka-detector.service --no-pager -n 200 || true
tail -n 120 /home/nemez/project_root/logs/detector.log || true


### Проверка Hailo (если используется)
systemctl --no-pager --full status hailort.service || true


### Перезапуск сервисов
sudo systemctl restart dd5ka-panel.service dd5ka-detector.service

## 6) Протокол работы ИИ-ассистента

1. Один ответ = **одна правка / одно действие / одна команда проверки**.
2. Любая правка оформляется как:
   - полный файл целиком, **или**
   - unified-diff с точным путём к файлу.
3. После правки ассистент обязан дать **одну** команду для проверки результата.
4. Никаких массовых изменений «всё сразу».  
   Итерации только пошаговые.
5. Любые изменения архитектуры (структуры каталогов, логики работы сервисов, модели ИИ, пайплайна обработки) — **только по RFC**, а не в обычном ответе.
6. Все изменения, которые касаются окружения или конфигурации, **обязательно** фиксируются в этом файле.
7. Если ассистент не понимает текущее состояние — он сначала выполняет диагностику (через команды из раздела 5), а уже потом предлагает правку.

## 7) Протокол входа нового ИИ-ассистента

Перед началом работы ассистент обязан:

1. Прочитать `PROMPT_MASTER.md` полностью.
2. Синхронизироваться с текущим кодом:
   - `src/panel/` — Flask-панель
   - `src/detector/` — YOLO-детектор
3. Если какие-либо файлы не были показаны в чате — запросить вывод (`cat`, `ls`, `diff`).
4. Сформировать краткий обзор: что уже реализовано и в каком состоянии.
5. Только после синхронизации с кодовой базой — предлагать правки.
6. Запрещено создавать новую реализацию “с нуля”, если код уже существует.
7. Все изменения — пошагово, по протоколу «один ответ = одна правка + одна команда проверки».

## 8) Протокол передачи чата новому ассистенту

Когда создаётся новый чат или подключается новый агент, пользователь обязан:

1. Указать, что проект ведётся по `PROMPT_MASTER.md`.
2. Сообщить путь к этому файлу (локально или в репозитории).
3. Сформулировать задачу в стиле:  
   «Прочитай `PROMPT_MASTER.md`, синхронизируйся с текущим кодом и продолжи работу пошагово».

Ассистент обязан:

1. Сначала подтвердить чтение `PROMPT_MASTER.md`.
2. Затем запросить текущее состояние кода (если нужно — вывод `ls`/`cat` отдельных файлов).
3. Сделать краткий обзор реального состояния (что уже есть, что не реализовано).
4. Только после синхронизации предложить первую минимальную правку.
5. Соблюдать правило: **никакого переписывания с нуля** при существующем коде.


## 9) Break-glass / восстановление ассистента

Если ассистент начал:
- терять контекст,
- игнорировать протокол,
- предлагать переписывание с нуля,
- или выдавать нерелевантные ответы,

то пользователь выполняет «перезагрузку ассистента» без потери проекта:

**Процедура восстановления:**

1. Сообщить ассистенту фразу:  
   «Восстанови контекст: прочитай PROMPT_MASTER.md и выполни входной протокол».
2. Ассистент обязан перечитать документ и синхронизироваться с кодовой базой.
3. Ассистент обязан выдать краткий обзор текущего состояния (snapshot).
4. После этого работа продолжается с того же места.

**Важно:**  
Перезагрузка ассистента не даёт права переписывать проект или структуру заново.  
Если предлагаются масштабные изменения — только через RFC.

## 10) Версионирование и синхронизация документа

Этот файл является частью кода и версионируется через git.

Правила обновления:
1. Любое изменение конфигурации, структуры, сервисов, путей или переменных окружения обязано быть отражено здесь.
2. Перед коммитом проверяется, что PROMPT_MASTER.md актуализирован.
3. Каждое значимое изменение фиксируется отдельным коммитом с сообщением вида:
   `docs: update PROMPT_MASTER (<что изменено>)`.
4. Новый ассистент не считается «вошедшим в проект», пока не подтвердит чтение актуальной версии файла из репозитория.


