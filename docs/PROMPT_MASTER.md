# PROMPT_MASTER v2.0 — DD-5KA · Архитектурная спецификация и протокол ассистентов

**Версия:** 2.0  
**Дата:** 2024-12-19  
**Статус:** Активная  

---

## Содержание

1. [Введение и область применения](#1-введение-и-область-применения)
2. [Назначение системы DD-5KA](#2-назначение-системы-dd-5ka)
3. [Аппаратная архитектура](#3-аппаратная-архитектура)
4. [Программная архитектура](#4-программная-архитектура)
5. [Роли участников](#5-роли-участников)
6. [Жизненный цикл разработки](#6-жизненный-цикл-разработки)
7. [Протокол входа ассистента](#7-протокол-входа-ассистента)
8. [RAW-навигация по репозиторию](#8-raw-навигация-по-репозиторию)
9. [Правила patch-разработки](#9-правила-patch-разработки)
10. [CI/CD: Mac → GitHub → RPi](#10-cicd-mac--github--rpi)
11. [Исполнительная модель Cursor](#11-исполнительная-модель-cursor)
12. [Интерфейс применения правок](#12-интерфейс-применения-правок)
13. [Требования к журналированию и стабильности](#13-требования-к-журналированию-и-стабильности)
14. [Подсистема CH4: Панель](#14-подсистема-ch4-панель)
15. [Подсистема CH4: Детектор](#15-подсистема-ch4-детектор)
16. [CH5+ (будущие расширения)](#16-ch5-будущие-расширения)
17. [Шаблон первого сообщения ассистента](#17-шаблон-первого-сообщения-ассистента)
18. [Шаблон patch-промпта для Cursor](#18-шаблон-patch-промпта-для-cursor)
19. [Недопустимое поведение ассистентов](#19-недопустимое-поведение-ассистентов)
20. [Глоссарий и резюме](#20-глоссарий-и-резюме)

---

## 1. Введение и область применения

Данный документ является архитектурной спецификацией системы DD-5KA и протоколом работы ассистентов (assistant protocol). Документ служит единым источником истины (single source of truth) для всех участников разработки и эксплуатации системы.

**Область применения:**
- Архитектурное описание системы DD-5KA
- Регламент работы ИИ-ассистентов
- Протоколы разработки и развертывания
- Технические спецификации компонентов

**Аудитория:** разработчики, ассистенты, операторы системы.

---

## 2. Назначение системы DD-5KA

**DD-5KA** — система детекции дронов на базе Raspberry Pi 5 с использованием YOLO-моделей для анализа видеопотока в реальном времени.

**Основные компоненты:**
- Детектор (detector): YOLO-инференс на CPU/GPU
- Панель (panel): веб-интерфейс для мониторинга и управления
- Система логирования событий детекции
- Интеграция с камерой Sony IMX500

**Текущий статус:** CH5-start (CPU-инференс YOLO) — выполнено
- Детектор работает на CPU (Ultralytics YOLO), события пишутся в `logs/detections.jsonl`
- Панель отдает оверлей поверх видеопотока: `GET /stream/overlay.mjpg` (порт :8098)
- Схема события `detection` расширена полем `"perf"`
- Переключение бэкенда: `DD5KA_BACKEND=cpu`

---

## 3. Аппаратная архитектура

### 3.1 Основные компоненты

**Raspberry Pi 5:**
- ОС: Debian 12 (aarch64)
- Процессор: ARM Cortex-A76
- Память: 8GB LPDDR4X

**Камера Sony IMX500:**
- Разрешение: 4056×3040 пикселей
- Интерфейс: MIPI CSI
- Управление: через `libcamera` / `rpicam-*`

**Опционально — AI-ускоритель Hailo-8 PCIe:**
- Для ускорения YOLO-инференса
- Поддержка через `DD5KA_BACKEND=hailo`

### 3.2 Пути и сервисы

**Репозиторий:** `/home/nemez/DD5KA`  
**Симлинк:** `/home/nemez/project_root -> /home/nemez/DD5KA`  
**Venv:** `/home/nemez/drone-env/bin/python`

**Сервисы (systemd):**
- `dd5ka-detector.service` — WorkingDirectory=`/home/nemez/project_root`, запускает `/home/nemez/project_root/src/detector/daemon.py`, лог: `/home/nemez/project_root/logs/detector.log`
- `dd5ka-panel.service` — запускает `/home/nemez/project_root/src/panel/app.py`, лог: `/home/nemez/project_root/logs/panel.log`

---

## 4. Программная архитектура

### 4.1 Структура проекта

```
/home/nemez/project_root/
├── src/
│   ├── panel/           # Flask-панель (веб-UI)
│   ├── detector/        # YOLO-инференс и обработка кадров
│   ├── __init__.py      # Пакетные инициализаторы
│   ├── panel/
│   │   ├── app.py       # Основное приложение Flask
│   │   ├── camera.py    # Модуль захвата кадров
│   │   └── overlay.py   # Модуль оверлея детекций
│   └── detector/
│       ├── daemon.py    # Демон детектора
│       └── yolo_cpu.py  # CPU-инференс YOLO
├── models/
│   └── cpu/
│       └── best.pt      # CPU-модель YOLO
├── configs/             # Конфигурационные файлы
├── logs/                # Логи сервисов и detections.jsonl
└── docs/                # Документация
```

### 4.2 Переменные окружения

**Детектор (`dd5ka-detector.service`):**
- `DD5KA_BACKEND=cpu|stub` — выбор бэкенда
- `DETECTOR_MIN_CONF=float` — порог уверенности (деф. 0.55; на тестах 0.25–0.35)
- `DETECTOR_CLASS_ALLOW=csv` — разрешенные имена (lower), напр. `dron,drone,дрон,uav`
- `DETECTOR_CLASS_IDS=csv` — разрешенные ID классов (НАПР.: `0`), применяется ДО name-фильтра (AND-логика)
- `IMG_MAX_SIDE=int` — макс. сторона кадра для инференса (деф. 1280; на тестах 1600)
- `PANEL_BASE_URL=http://127.0.0.1:8098`, `DETECTOR_POLL_SEC=5`
- `LOG_DIR=/home/nemez/project_root/logs`

**Панель (`dd5ka-panel.service`):**
- `SNAPSHOT_MAX_SIDE=int` — деф. 960 (длинная сторона)
- `OVERLAY_MAX_SIDE=int` — деф. 640
- `OVERLAY_FPS=int` — деф. 4 (частота отдачи кадров)
- `OVERLAY_CAPTURE_FPS=int` — деф. 2 (частота реального захвата)
- `OVERLAY_DET_MAX_AGE_MS=int` — деф. 4000 (макс. «возраст» события для отрисовки)

### 4.3 Модель и артефакты

**CPU-модель YOLO:** `/home/nemez/DD5KA/models/cpu/best.pt`  
Каталоги создавать при отсутствии: `/home/nemez/DD5KA/models/cpu/`.

### 4.4 Схема событий

**Схема события detection (detections.jsonl):**

```json
{
  "type": "detection",
  "backend": "cpu",
  "model": {
    "path": "/path/to/model.pt",
    "framework": "ultralytics",
    "version": "auto"
  },
  "image": {
    "width": 1280,
    "height": 960
  },
  "detections": [
    {
      "class_id": 0,
      "class_name": "drone",
      "conf": 0.85,
      "bbox_xyxy": [100, 200, 300, 400]
    }
  ],
  "perf": {
    "infer_ms": 150,
    "resized": [1280, 960]
  }
}
```

---

## 5. Роли участников

### 5.1 Пользователь
- Инициирует задачи и принимает решения
- Управляет процессом разработки
- Контролирует качество результата

### 5.2 Чат-ассистент (ChatGPT / LLM-чат)
- Анализирует состояние проекта
- Формирует задачи в виде промптов для Cursor
- **НЕ пишет код напрямую**
- Контролирует результат и проверку
- При необходимости формирует уточняющий запрос к Cursor

### 5.3 Cursor (IDE-агент)
- **Единственный исполнитель кода**
- Генерирует патчи (patch) — diff или полный файл
- Выдает одну команду проверки
- Не решает ЧТО делать — только исполняет сформулированную задачу

### 5.4 Raspberry Pi (runtime)
- Исполняющая среда для системы DD-5KA
- **НЕ является средой разработки**
- Обновляется только через git pull + systemctl restart

---

## 6. Жизненный цикл разработки

### 6.1 Этапы разработки

**CH0-CH3:** Базовая инфраструктура и настройка  
**CH4:** Реализация панели и детектора  
**CH5-start:** CPU-инференс YOLO (текущий статус)  
**CH5+:** Будущие расширения (Hailo, streaming, улучшения)

### 6.2 Режим работы

**Выполнение на RPi — только one-liner через ssh.** После каждого шага оператор отвечает «готово», затем следующий шаг. Контур неизменен: **Mac → GitHub → RPi (pull) → systemctl**.

---

## 7. Протокол входа ассистента

### 7.1 Обязательные шаги

Перед началом работы ассистент обязан:

1. Прочитать `PROMPT_MASTER.md` полностью
2. Синхронизироваться с текущим кодом через RAW-ссылки
3. Если какие-либо файлы не были показаны в чате — запросить вывод (`cat`, `ls`, `diff`)
4. Сформировать краткий обзор: что уже реализовано и в каком состоянии
5. Только после синхронизации с кодовой базой — предлагать правки
6. Запрещено создавать новую реализацию "с нуля", если код уже существует
7. Все изменения — пошагово, по протоколу «один ответ = одна правка + одна команда проверки»

### 7.2 Чек-лист CH5

- Проверить симлинк `/home/nemez/project_root -> /home/nemez/DD5KA`
- Проверить модель: `/home/nemez/DD5KA/models/cpu/best.pt`
- Выставить `DD5KA_BACKEND=cpu` (drop-in), перезапустить детектор
- Убедиться: в `logs/detections.jsonl` идут `type:"detection"`
- Проверить панель: `/snapshot` (200 и >10KB), `/api/last`, `/stream/overlay.mjpg` (200 и поток)
- При ImportError относительных импортов под systemd — добавить `src` в `sys.path` и перейти на абсолютные импорты

### 7.3 Формат команд для RPi

Все команды для RPi всегда выдаются в формате:
`ssh nemez@<RPi_IP> '<команда>'`
По умолчанию работа ведется с Mac, локальный терминал — Mac.

### 7.4 Стандартный smoke-test

Стандартный первичный smoke-test связи сервисов: `/api/health` → `/snapshot` → `/api/last` (в указанной последовательности).

---

## 8. RAW-навигация по репозиторию

### 8.1 Базовые ссылки

**Публичный URL (read-only для ассистентов):**
https://github.com/nemezkarl-source/DD5KA

**PROMPT_MASTER (RAW):**
https://raw.githubusercontent.com/nemezkarl-source/DD5KA/main/docs/PROMPT_MASTER.md

**Шаблон для любого файла:**
https://raw.githubusercontent.com/nemezkarl-source/DD5KA/main/<путь/к/файлу>

### 8.2 Ключевые файлы проекта

**Flask-панель (app.py):**
https://raw.githubusercontent.com/nemezkarl-source/DD5KA/main/src/panel/app.py

**systemd unit панели:**
https://raw.githubusercontent.com/nemezkarl-source/DD5KA/main/configs/dd5ka-panel.service

**Детектор:**
- пока отсутствует в репозитории (разработка на RPi)
- ассистент НЕ должен генерировать новый код без синхронизации с фактической версией
- если потребуется, ассистент может запросить RAW-ссылку после того, как файл окажется в репозитории

### 8.3 Правила RAW-доступа

1. Ассистент обязан читать файлы через RAW-ссылки, а не через HTML UI GitHub
2. Пользователь не обязан присылать код вручную
3. Запросы "пришли файл src/panel/app.py" считаются ошибочным входом
4. Если файл отсутствует в репозитории — ассистент обязан запросить загрузку, а не пытаться писать с нуля

---

## 9. Правила patch-разработки

### 9.1 Атомарность действий

Каждая выдача ассистента содержит одно логическое действие (один завершенный результат).

**Примеры атомарных действий:**
- «деплой systemd-сервиса» = одно действие, даже если внутри несколько команд
- «pull+restart на RPi» = одно действие
- «git add+commit+push (на Mac)» = одно действие
- «smoke-test /health → /snapshot → /api/last» = одно действие

**НЕ атомарные:** patch для Cursor → commit/push → pull/restart → проверка — это разные действия и идут отдельными шагами.

### 9.2 Формат патчей

Любая правка оформляется как:
- полный файл целиком, **или**
- unified-diff с точным путем к файлу

### 9.3 Краткое назначение перед командой

Перед блоком команд — одна строка с назначением шага («Перезапускаем …», «Диагностика …», «Деплой …»).

### 9.4 Объединение совместимых команд

Если несколько команд относятся к одному логическому действию и не конфликтуют, их допустимо выдавать одним блоком (например: `systemctl daemon-reload && systemctl restart ...`). Но длинная цепочка разных действий всегда делится на отдельные шаги.

---

## 10. CI/CD: Mac → GitHub → RPi

### 10.1 Контур обновления кода

Проект DD-5KA использует строгий односторонний CI/CD-контур поставки кода:

1. Разработка выполняется **только на Mac**. Raspberry Pi не является средой разработки
2. Код генерируется и правится **только через Cursor** (IDE), а не в чате
3. После генерации патчей Cursor → изменения коммитятся и пушатся в GitHub
4. GitHub является единым источником правды. Raspberry Pi = runtime-копия репозитория
5. Обновление на устройстве выполняется ТОЛЬКО через:
   ```bash
   git pull
   systemctl restart <service>
   ```
6. Запрещено вносить правки вручную на RPi (nano, vim, python -c и т.п.)
7. Любой запрос «правь файл на Raspberry Pi» = нарушение протокола

### 10.2 Команды развертывания

**Mac → GitHub:**
```bash
git add <files> && git commit -m "<msg>" && git push
```

**RPi (pull):**
```bash
ssh nemez@<pi> "cd /home/nemez/DD5KA && git pull"
```

**RPi (env + restart, пример — детектор):**
```bash
ssh nemez@<pi> 'sudo tee /etc/systemd/system/dd5ka-detector.service.d/override.conf >/dev/null <<EOF
[Service]
Environment=DD5KA_BACKEND=cpu
Environment=DETECTOR_MIN_CONF=0.35
Environment=DETECTOR_CLASS_ALLOW=dron,drone
Environment=DETECTOR_CLASS_IDS=0
Environment=IMG_MAX_SIDE=1600
EOF
sudo systemctl daemon-reload && sudo systemctl restart dd5ka-detector.service'
```

**RPi (env + restart, пример — панель):**
```bash
ssh nemez@<pi> 'sudo tee /etc/systemd/system/dd5ka-panel.service.d/override.conf >/dev/null <<EOF
[Service]
Environment=SNAPSHOT_MAX_SIDE=960
Environment=OVERLAY_MAX_SIDE=640
Environment=OVERLAY_FPS=4
Environment=OVERLAY_CAPTURE_FPS=2
Environment=OVERLAY_DET_MAX_AGE_MS=4000
EOF
sudo systemctl daemon-reload && sudo systemctl restart dd5ka-panel.service'
```

---

## 11. Исполнительная модель Cursor

### 11.1 Разделение ролей

**Архитектурное правило CH4:**
Код генерирует и изменяет **Cursor в IDE**, чат-ассистент только **инициирует patch-задачи**.

**Роли:**
- Чат-ассистент: анализирует, формирует задачи, контролирует результат
- Cursor: единственный исполнитель кода, генерирует патчи, выдает команды проверки

### 11.2 Поведение по умолчанию

1. Если чат по ошибке начинает писать код — он обязан **немедленно преобразовать попытку в корректный Cursor-промпт**
2. Любая правка = patch в Cursor → затем применение на RPi → проверка
3. Запрещено генерировать код в чате напрямую (минуя Cursor)
4. Пользователь не обязан вручную пересылать код — Cursor и RAW-доступ обеспечивают синхронизацию

### 11.3 Фикс импортов под systemd

**Фикс импортов при запуске через systemd:** в скриптах-энтрипоинтах добавлять `src` в `sys.path` и использовать абсолютные импорты.

**Применено:**
- `src/detector/daemon.py` → `sys.path` + `from detector.yolo_cpu import ...`
- `src/panel/app.py` → `sys.path` + `from panel.overlay import ...`
- Создавать `__init__.py` для пакетов при необходимости

---

## 12. Интерфейс применения правок

### 12.1 Обязательная последовательность

Каждая правка кода завершается **выдачей полного набора команд для применения**:

1. **Обновление репозитория:**
   ```bash
   git add ...
   git commit ...
   git push
   ```

2. **Применение на Raspberry Pi:**
   ```bash
   ssh nemez@pi-drone.local
   cd /home/nemez/project_root
   git pull
   sudo systemctl restart <service>
   ```

3. **Проверка результата:**
   ```bash
   curl http://pi-drone.local:8098/healthz
   # или
   tail -n 50 logs/...
   ```

### 12.2 Критерии завершения

Правка считается завершенной **ТОЛЬКО** после:
- push в GitHub
- pull на RPi
- restart службы
- подтвержденной проверки

Чат-ассистент обязан всегда выдавать эти команды автоматически.

### 12.3 Политика перезапуска сервисов

- Панель (`dd5ka-panel.service`) и детектор (`dd5ka-detector.service`) независимы
- Перезапуски выполняются адресно: при изменениях панели — только панель; при изменениях детектора — только детектор (если не оговорено иначе)
- При отладке панели допускается временная остановка детектора для исключения конкуренции за камеру
- Политика «hard»: при отладке стабильности `/snapshot` детектор должен быть остановлен до восстановления стабильной 200-ответности панели

### 12.4 Семантика camera в /api/health

- `ok` — камера доступна (нет блокирующих rpicam-процессов, media-устройства читаются)
- `busy` — обнаружен висящий или конкурирующий rpicam-процесс (камера занята, требуется очистка процессов/пайплайна)
- `error` — медиа-устройства недоступны или иная системная ошибка

---

## 13. Требования к журналированию и стабильности

### 13.1 Логирование событий

Все события детекции записываются в `logs/detections.jsonl` в формате JSON Lines.

### 13.2 Стабильность сервисов

- Сервисы должны автоматически перезапускаться при сбоях
- Логи должны содержать достаточно информации для диагностики
- Система должна быть устойчива к временным сбоям камеры

### 13.3 Диагностика

**Команды диагностики:**

```bash
# detector
ssh nemez@<pi> 'systemctl --no-pager --full status dd5ka-detector.service'
ssh nemez@<pi> 'journalctl -xeu dd5ka-detector.service -n 120 --no-pager'
ssh nemez@<pi> 'tail -n 60 /home/nemez/DD5KA/logs/detections.jsonl'

# panel
ssh nemez@<pi> 'curl -sI http://127.0.0.1:8098/stream/overlay.mjpg | egrep -i "HTTP/|Content-Type"'
ssh nemez@<pi> 'curl -s --max-time 5 http://127.0.0.1:8098/stream/overlay.mjpg -o /dev/null -w "bytes=%{size_download}\n"'
ssh nemez@<pi> 'curl -s http://127.0.0.1:8098/api/last'

# yolo
ssh nemez@<pi> '/home/nemez/drone-env/bin/python -c "import ultralytics; print(ultralytics.__version__)"'
ssh nemez@<pi> "/home/nemez/drone-env/bin/python -c \"import sys,os; p=os.path.abspath('/home/nemez/DD5KA/src'); sys.path.insert(0,p); import detector.yolo_cpu as m; print('ok', hasattr(m,'YOLOCPUInference'))\""
```

---

## 14. Подсистема CH4: Панель

### 14.1 Архитектура панели

Панель реализована на Flask и предоставляет веб-интерфейс для мониторинга системы.

**Основные модули:**
- `app.py` — основное приложение Flask
- `camera.py` — модуль захвата кадров через rpicam-still
- `overlay.py` — модуль наложения детекций на видеопоток

### 14.2 Эндпоинт /snapshot (формальное ТЗ)

**Назначение:** Получение снимка с камеры в формате JPEG.

**Метод:** GET  
**URL:** `/snapshot`  
**Порт:** 8098

**Параметры запроса:**
- `max_side` (опционально): максимальная сторона изображения в пикселях (по умолчанию 960)

**Ответ:**
- **Успех (200):** JPEG-изображение с заголовком `Content-Type: image/jpeg`
- **Ошибка (500):** JSON с описанием ошибки

**Требования:**
- Размер ответа должен быть >10KB при успешном захвате
- Время ответа не должно превышать 5 секунд
- При временных сбоях rpicam-still должен использоваться retry-механизм

**Реализация:**
Использует `src/panel/camera.py` с вызовом `rpicam-still`:
```bash
rpicam-still -n -o - -t <timeout_ms> --quality 70 --thumb none --width <w> --height <h>
```

### 14.3 Будущий streaming (MJPEG)

**Планируемый эндпоинт:** `GET /stream/overlay.mjpg`

**Текущая реализация:**
- Кадр берется напрямую через `panel.camera.capture_jpeg` (не через `/snapshot`)
- Рисуем рамки по **последнему** событию `detections.jsonl`; пустые события очищают рамки
- Anti-stale: `event.ts` проверяется против `OVERLAY_DET_MAX_AGE_MS`
- Масштабирование bbox: из `event.image(w,h)` в `frame(w,h)`
- Разделены `OVERLAY_FPS` (отдача) и `OVERLAY_CAPTURE_FPS` (захват); используется `last_ok_frame`
- При отсутствии кадра — черная заглушка «NO FRAME»
- Лог: `overlay frame: dets=<N>, age_ms=<int>, draw_ms=<int>, fresh=<True|False>`

### 14.4 Интерфейс камеры (будущее расширение)

**Helper: `src/panel/camera.py`**
- `capture_jpeg(max_side, timeout_ms, retries)` вызывает `rpicam-still`
- Размеры считаются по аспекту сенсора 4056×3040; ретраи при сбоях

---

## 15. Подсистема CH4: Детектор

### 15.1 Текущий статус

Детектор находится в разработке на RPi и пока не полностью синхронизирован с репозиторием.

### 15.2 Архитектура (планируемая)

**Основные компоненты:**
- `daemon.py` — основной демон детектора
- `yolo_cpu.py` — реализация CPU-инференса YOLO

**Функциональность:**
- Захват кадров с камеры
- YOLO-инференс на CPU
- Запись событий в `logs/detections.jsonl`
- Интеграция с панелью через HTTP API

---

## 16. CH5+ (будущие расширения)

### 16.1 Тюнинг и эксперименты

- `DETECTOR_MIN_CONF` 0.25–0.50 — подобрать под задачу/освещение
- `IMG_MAX_SIDE` 960–1600 — больше размер = лучше мелкие цели, но медленнее
- `DETECTOR_CLASS_IDS=0` — надежная фильтрация по ID для класса DRON
- Панель: `OVERLAY_MAX_SIDE=640..800`, `OVERLAY_CAPTURE_FPS=1..2` — снизить конкуренцию за камеру

### 16.2 Известные грабли

- «Залипание» рамок: рисуем строго по **последнему** событию; пустые detections очищают экран; проверяем свежесть
- ImportError относительных импортов под systemd: добавляйте `src` в `sys.path`, используйте абсолютные импорты
- Поток есть, но bytes=0: генератор overlay обязан yield'ить кадры даже при сбое захвата (используем last_ok_frame/заглушку)
- /snapshot 500: это временные сбои `rpicam-still` — работает retry-логика, не спамить запросами

---

## 17. Шаблон первого сообщения ассистента

```
Я прочитал PROMPT_MASTER v2.0 и готов к работе с проектом DD-5KA.

Для синхронизации с текущим состоянием кода мне нужно получить доступ к следующим файлам через RAW-ссылки:
- src/panel/app.py
- src/detector/daemon.py (если доступен в репозитории)
- configs/dd5ka-panel.service

После получения доступа к коду я выполню стандартный smoke-test и предоставлю краткий обзор текущего состояния системы.

Готов приступить к работе согласно протоколу "один ответ = одна правка + одна команда проверки".
```

---

## 18. Шаблон patch-промпта для Cursor

```
Задача: [краткое описание задачи]

Контекст:
- Файл: [путь к файлу]
- Текущая функциональность: [описание текущего состояния]
- Требуемые изменения: [конкретные требования]

Технические требования:
- [список технических ограничений]
- [требования к совместимости]

Ожидаемый результат:
- [описание ожидаемого поведения после изменений]

Команда проверки:
- [команда для проверки результата]
```

---

## 19. Недопустимое поведение ассистентов

### 19.1 Критические нарушения

1. **Генерация кода в чате** — код должен генерироваться только через Cursor
2. **Переписывание с нуля** при существующем коде без синхронизации
3. **Массовые изменения** без пошагового подхода
4. **Игнорирование протокола** «один ответ = одна правка»
5. **Работа без синхронизации** с текущим состоянием кода

### 19.2 Нарушения процедур

1. **Запрос кода вручную** вместо использования RAW-ссылок
2. **Предложение правок** без предварительной диагностики
3. **Изменение архитектуры** без RFC
4. **Работа на RPi** как среде разработки

### 19.3 Процедура восстановления

Если ассистент начал:
- терять контекст
- игнорировать протокол
- предлагать переписывание с нуля
- или выдавать нерелевантные ответы

**Процедура восстановления:**
1. Сообщить ассистенту фразу: «Восстанови контекст: прочитай PROMPT_MASTER.md и выполни входной протокол»
2. Ассистент обязан перечитать документ и синхронизироваться с кодовой базой
3. Ассистент обязан выдать краткий обзор текущего состояния (snapshot)
4. После этого работа продолжается с того же места

---

## 20. Глоссарий и резюме

### 20.1 Ключевые термины

- **Cursor (IDE-агент, исполнитель кода)** — единственный инструмент для генерации и изменения кода
- **Patch (патч)** — изменение кода в формате diff или полного файла
- **CI/CD (процесс поставки кода)** — Mac → GitHub → RPi
- **Runtime (исполняющая среда)** — Raspberry Pi, где работает система
- **Smoke-test** — базовая проверка работоспособности сервисов
- **RAW-доступ** — получение файлов напрямую через GitHub RAW API

### 20.2 Принципы работы

1. **Единый источник истины** — данный документ
2. **Атомарность действий** — одна задача = один ответ
3. **Синхронизация перед действием** — всегда знать текущее состояние
4. **Cursor-центричность** — код только через IDE
5. **Строгий CI/CD** — Mac → GitHub → RPi

### 20.3 Контрольные точки

- ✅ Чтение PROMPT_MASTER.md
- ✅ Синхронизация с кодом через RAW-ссылки
- ✅ Smoke-test сервисов
- ✅ Формирование обзора состояния
- ✅ Готовность к пошаговой работе

---

## История изменений (Revision History)

**v2.0 (2024-12-19):**
- Полный рефакторинг документа
- Новая структура с 20 разделами
- Интеграция всех накопленных знаний
- Устранение противоречий и дублирований
- Формализация протоколов работы

**v1.x (предыдущие версии):**
- Фрагментированная структура
- Накопление знаний через итерации
- Базовые протоколы работы

---

**Конец документа**